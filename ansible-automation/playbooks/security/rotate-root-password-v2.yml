---
- name: Rotate root passwords using Vault-generated passwords
  hosts: linux_servers
  become: true
  gather_facts: true

  vars:
    vault_addr:         "http://mskd-vault.phs31.local:8200"   # ← обязательно HTTPS!
    vault_namespace:    ""
    vault_mount_path:   "approle"
    vault_secret_prefix: "servers/root-passwords"

    vault_auth_method:  "approle"
    vault_role_id:      "{{ lookup('ansible.builtin.env', 'VAULT_ROLE_ID')     | default(omit) }}"
    vault_secret_id:    "{{ lookup('ansible.builtin.env', 'VAULT_SECRET_ID')   | default(omit) }}"

    password_policy_name: "strong-root"   # имя политики, созданной выше

  tasks:

    # 1. Генерируем пароль прямо в Vault и сразу получаем его значение
    - name: Generate strong root password inside HashiCorp Vault
      community.hashi_vault.vault_read:
        url:          "{{ vault_addr }}"
        namespace:    "{{ vault_namespace | default(omit) }}"
        auth_method:  "{{ vault_auth_method }}"
        role_id:      "{{ vault_role_id     | default(omit) }}"
        secret_id:    "{{ vault_secret_id   | default(omit) }}"

        path:         "sys/policies/password/{{ password_policy_name }}/generate"
      register: vault_password_result
      delegate_to:  localhost
      run_once:     false   # каждый сервер — свой уникальный пароль
      no_log:       true


    # Извлекаем сгенерированный пароль
    - name: Set fact with generated password
      ansible.builtin.set_fact:
         new_root_password: "{{ vault_password_result.data.data.password }}"
#        new_root_password: "{{ vault_password_result.data.password }}"
      no_log: true


    # 2. Меняем пароль на сервере
    - name: Change root password on target host
      ansible.builtin.user:
        name:           root
        password:       "{{ new_root_password | password_hash('sha512') }}"
        update_password: always
      no_log: true
      register: passwd_change


    # 3. Сохраняем сгенерированный пароль в KV v2
    - name: Store Vault-generated root password in HashiCorp Vault
      community.hashi_vault.vault_kv2_write:
        url:          "{{ vault_addr }}"
        namespace:    "{{ vault_namespace | default(omit) }}"
        auth_method:  "{{ vault_auth_method }}"
        role_id:      "{{ vault_role_id     | default(omit) }}"
        secret_id:    "{{ vault_secret_id   | default(omit) }}"

        mount_point:  "{{ vault_mount_path }}"
        path:         "{{ vault_secret_prefix }}/{{ inventory_hostname | lower }}"

        data:
          password:     "{{ new_root_password }}"
          changed_at:   "{{ ansible_date_time.iso8601 }}"
          changed_by:   "ansible-rotate-root-vault-generated"
          hostname:     "{{ inventory_hostname }}"
          policy_used:  "{{ password_policy_name }}"

#        cas:          0   # или реализуйте проверку версии, если нужно
      no_log:       false
      delegate_to:  localhost
      register: vault_write
      failed_when:  vault_write.failed


    # 4. Уведомление (безопасное — без самого пароля)
    - name: Show rotation result
      ansible.builtin.debug:
        msg: >-
          Root password rotated and stored in Vault.
          Path → {{ vault_mount_path }}/data/{{ vault_secret_prefix }}/{{ inventory_hostname | lower }}
          Generated by Vault policy: {{ password_policy_name }}
          Timestamp: {{ ansible_date_time.iso8601 }}
      when: vault_write is success