---
- name: Rotate root passwords on Linux servers and store in HashiCorp Vault
  hosts: linux_servers
  become: true
  gather_facts: true

  vars:
    vault_addr:         "http://mskd-vault.phs31.local:8200"      # ← используйте HTTPS в продакшене!
    vault_namespace:    ""
    vault_mount_path:   "secret"
    vault_secret_prefix: "servers/root-passwords"             # ← более логичная структура

    vault_auth_method:  "approle"
    vault_role_id:      "{{ lookup('ansible.builtin.env', 'VAULT_ROLE_ID')     | default(omit) }}"
    vault_secret_id:    "{{ lookup('ansible.builtin.env', 'VAULT_SECRET_ID')   | default(omit) }}"

  tasks:

    # 1. Генерация пароля — только один раз на весь запуск
    - name: Generate new strong root password (once per run)
      ansible.builtin.set_fact:
        new_root_password: "{{ lookup('password', '/dev/null length=10 chars=ascii_letters,digits,symbols punctuation') }}"
      run_once: true
      delegate_to: localhost
      no_log: false

    # 2. Меняем пароль на сервере
    - name: Change root password on target host
      ansible.builtin.user:
        name:           root
        password:       "{{ new_root_password | password_hash('sha512') }}"
        update_password: always
      no_log: false
      register: passwd_change


    # 3. Сохраняем в Vault — только с контроллера
    - name: Store new root password in HashiCorp Vault (KV v2)
      community.hashi_vault.vault_kv2_write:
        url:          "{{ vault_addr }}"
        namespace:    "{{ vault_namespace | default(omit) }}"
        auth_method:  "{{ vault_auth_method }}"
        role_id:      "{{ vault_role_id     | default(omit) }}"
        secret_id:    "{{ vault_secret_id   | default(omit) }}"

        mount_point:  "{{ vault_mount_path }}"
        path:         "{{ vault_secret_prefix }}/{{ inventory_hostname | lower }}"

        data:
          password:     "{{ new_root_password }}"
          changed_at:   "{{ ansible_date_time.iso8601 }}"
          changed_by:   "ansible-rotate-root"
          hostname:     "{{ inventory_hostname }}"
          os_family:    "{{ ansible_os_family }}"
          distribution: "{{ ansible_distribution }} {{ ansible_distribution_version }}"

        # Важные опции для безопасности и контроля версий
        cas:          0                   # 0 = перезаписать всегда
        # cas: "{{ lookup('community.hashi_vault.vault_kv2_read', path=..., field='metadata.version') | default(0) + 1 }}"
        # ↑ раскомментировать для optimistic locking (если нужна защита от параллельных изменений)

      no_log: false
      delegate_to: localhost
      run_once: false                     # каждый хост — свой путь в Vault
      register: vault_write
      failed_when: vault_write.failed


    # 4. Логирование/уведомление (безопасное)
    - name: Show rotation result (without password!)
      ansible.builtin.debug:
        msg: >-
          Root password rotated successfully on {{ inventory_hostname }}
          New password stored in Vault: {{ vault_mount_path }}/data/{{ vault_secret_prefix }}/{{ inventory_hostname | lower }}
          Timestamp: {{ ansible_date_time.iso8601 }}
      when: vault_write is success


    # 5. Дополнительная защита — если Vault запись не удалась — откатываем пароль обратно
    - name: Emergency rollback - restore previous root password (if vault write failed)
      ansible.builtin.user:
        name:           root
        password:       "{{ previous_root_password | password_hash('sha512') }}"
        update_password: always
      when:
        - vault_write.failed | default(false)
        - previous_root_password is defined
      no_log: true
      ignore_errors: true   # чтобы не остановить весь плейбук